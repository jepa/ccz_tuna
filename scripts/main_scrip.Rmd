---
title: "Untitled"
author: "Juliano Palacios"
date: "2023-02-10"
output: html_document
---

```{r setup, include=FALSE, message = F, warning = F}

library(MyFunctions)

packages <- c(
  # "readxl", # Read dataframe
  # "data.table", # Read dataframe (Fast!)
  # "wesanderson",
  "tidyverse", # for all data wrangling and ggplot
  "janitor", # for data cleaning
  # "tidytext", # to order the facet wrap https://juliasilge.com/blog/reorder-within/
  # "cowplot", # for figures 1 and 3
  # "ggimage", #for reading images to the circular plot
  # "ggrepel", # for nice plot labels
  # "ggsflabel", # for nice sf_plots labels
  # "spdep", # for poly2nb old
  "sf", #Spatial analysis 
  "sp", #Spatial analysis 
  # "purrr",#Spatial analysis
  # "rgdal", #Spatial analysis
  # "tools", #Spatial analysis 
  # "parallel", # for parallelization
  # "taxize", # For getting species names
  # "rfishbase", # for species ecosystem affinity
  # "zoo", #for runing mean
  # "pgirmess", # for dune test after kurtis wallas
  "rnaturalearth" # For maps
  # "R.matlab" # For Gabs distributions
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

# 
# file.source <- list.files("/Users/juliano/Data/ccz_tuna/doctools/lib/",full.names = T)
# 
# lapply(file.source,source)
# 


```

# Methods

## Spatial exploration

From Jesse Van Der Grient at UH

I have added my shapefiles (see link below) based on 50, 100, and 200 km away from contract areas (indicated by the 0.5, 1 and 2 after the names) for the three different deposit types across the globe. I used these for the Watson database - the RFMO version has a clipped CCZ file, but I don't think we want to use that? Do let me know if you do want that. The projection is WGS 84, EPSG:4326. 

**Note:** We are using only the PMN shapefile

The acronyms are the theee different mineral resources, and each of those corresponds to areas where exploration licences have been granted in different oceans. For this project we will focus on PMN - polymetallic nodules of the Pacific Ocean.


### Map of CFC - cobalt ferromanganese crusts (NOT)

```{r cmc_maps, eval = F, echo = F}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "cfc"

shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) %>% 
  mutate(Buffer = 50)# 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) %>% 
  mutate(Buffer = 100) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) %>% 
  mutate(Buffer = 200) # 200 kmm buffer

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

# ggplot() +
#   geom_sf(data = shp2, color = "blue") +
#   geom_sf(data = shp1, color = "green") +
#   geom_sf(data = shp05, color = "red") +
#   geom_sf(data = world_land, aes()) +
#   ggtitle(paste("Projections for",shp_name))

```

### PMN - polymetallic nodules (YES)

```{r pms_maps, eval = T, echo = T, message = FALSE}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "pmn"

# crop figure to CCZ
my_crop <- function(x){
  x <- st_crop(x,xmax = -100,
               xmin = -180,
               ymax = 35,
               ymin = -35)
  return(x)
}


shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) %>% # 200 kmm buffer
  my_crop(.) # 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) %>% # 200 kmm buffer
  my_crop(.) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) %>% # 200 kmm buffer
  my_crop(.) %>% 
  mutate(zone = "ccv")

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

# ggplot() +
#   geom_sf(data = shp2, color = "blue") +
#   geom_sf(data = shp1, color = "green") +
#   geom_sf(data = shp05, color = "red") +
#   geom_sf(data = world_land, aes()) +
#   ggtitle(paste("Projections for",shp_name))


```


#### Supplemental figure for study area

```{r}

# RFMO map
rfmo_map <- my_sf("RFMO") %>% 
  filter(RFMO_nm_s %in% c("IATTC","WCPFC")) %>% #44 and
  st_simplify(preserveTopology = TRUE, dTolerance = 0.1) %>% 
  st_shift_longitude() #Shitfs longitudes ti center the pacific

world_eez <- my_sf("SAU",simple = 1000)

world_land <- world_land <- ne_countries(scale = 'medium', returnclass = c("sp"))

# Crop world land to match pacific centered map
# https://rpubs.com/valentin/pacific-centered-map-voronoi-tessellation
box_cut <- bbox2SP(n = 90, s = -90, w = -70, e = 90, proj4string = world_land@proj4string)

# Crop it
world_crop <- gDifference(world_land, box_cut) %>% 
  st_as_sf() %>% # change from sp to sf object/class
  st_shift_longitude() %>% # Shift it
  st_simplify(preserveTopology = TRUE, dTolerance = 0.1)


rfmo_map %>%
  st_simplify(preserveTopology = TRUE, dTolerance = 1) %>%
  st_shift_longitude() %>%
  ggplot() +
  # geom_sf(data = world_crop, aes())
  geom_sf(aes(fill = RFMO_nm_s, color = RFMO_nm_s)) +
  geom_sf(data = world_crop, aes(), fill = "beige",color ="black") +
  theme_bw() +
  scale_fill_brewer("RFMO") +
  scale_color_brewer("RFMO") +
  geom_sf(data = shp05 %>% st_shift_longitude(),aes(), color = "red", fill ="NA") +
  geom_sf(data = shp1 %>% st_shift_longitude(), color = "grey", fill ="NA") +
  geom_sf(data = shp2 %>% st_shift_longitude(), color = "black", fill ="NA")




```

### PMS - polymetallic sulphides (NOT)

```{r pms_maps, eval = F, echo = F}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "pms"

shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) # 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) # 200 kmm buffer

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

ggplot() +
  geom_sf(data = shp2, color = "blue") +
  geom_sf(data = shp1, color = "green") +
  geom_sf(data = shp05, color = "red") +
  geom_sf(data = world_land, aes()) +
  ggtitle(paste("Projections for",shp_name))

```


## Percentage change maps

To be discussed there is the option of using sensitivity analysis runs or just reference runs... Do they report just the reference model?

REF = mean of four climate-derived (IPSL, GFDL, MIROC and MPI)
NEMO-PISCES ocean simulations; ST = genetic adaptation to increasing temperature; SP = 10%
increase of primary production in tropical region defined by 27Â°C isotherm; SO = no change in
dissolved oxygen content over forecast period, and PH = negative impact of ocean acidification of larval
survival (for yellowfin tuna only).


## Create Data grid

This sub step is to easier identify the CCZ zone, no need to run

```{r}
grid_data <- data_extraction(file.cc$rcp8.5[1],
                             time_0 = c(2000,1),
                             time_n = c(2011,12),
                             region = region) %>% 
  rowid_to_column()


grid_sf <- st_as_sf(grid_data,
                    coords = c("lon","lat"),
                    crs =4326
)

ccz_data <- st_join(shp2,
                    grid_sf,
                    join = st_intersects)

ccz_index <- as.data.frame(ccz_data) %>% 
  select(rowid)

write_csv(ccz_index,"ccz_index.csv")


```


# Results

## Results Control Panel


```{r}

source("../scripts/functions.R")
# GLobal variables
region <- c(120.5,289.5,-45,45)
life.stage<-"adult";
rcps <- c(4.5,8.5) # Keep both scenarios
CM<-c("GFDL","IPSL","MIROC","MPI")
# CM <- "GFDL"
SC <- "REF"
spp <- c("skj","yft","bet")


# Files paths
file.cc<-list(rcp8.5=NULL,rcp4.5=NULL)
```

## Proportion change

```{r}

# Historical proportion
# Set years for function
years <- seq(2009,2018,1)

suppressMessages( # remove annoying messages from function
  
  proportion_hist <- bind_rows(
    lapply(years, data_analysis, sp = "skj", output = "NA"),
    lapply(years, data_analysis, sp = "yft", output = "NA"),
    lapply(years, data_analysis, sp = "bet", output = "NA")
  ) %>% 
    select(-h_value) %>% 
    mutate( time_step = "present")
  
)

# Duplicate historical values for both rcp...

historical_output <- proportion_hist %>% 
  filter(rcp == "historical") %>% 
  mutate(rcp = "rcp45")

proportion_hist_corrected <- proportion_hist %>% 
  mutate(rcp = ifelse(rcp =="historical","rcp85",rcp)) %>% 
  bind_rows(historical_output)

# Future proportion
# Set years for function
years <- seq(2045,2055,1)

suppressMessages( # remove annoying messages from function
  
  proportion_fut <- bind_rows(
    lapply(years, data_analysis, sp = "skj", output = "NA"),
    lapply(years, data_analysis, sp = "yft", output = "NA"),
    lapply(years, data_analysis, sp = "bet", output = "NA")
  )%>% 
    select(-h_value) %>% 
    mutate( time_step = "future")
  
)


# Bind rows for plotting
proportion_data <- bind_rows(proportion_hist_corrected,proportion_fut)

```

### Plot grid

```{r grid_map, eval = T, echo = F}

proportion_data %>% 
  # Average by ttime step
  group_by(time_step,lon,lat,zone,rcp,spp) %>% 
  summarise(mean_time = mean(total_value)) %>% 
  spread(time_step,mean_time) %>% 
  mutate(per_change = round((future-present)/present*100)) %>% 
  mutate(per_change = ifelse(per_change>100,100,per_change)) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = per_change,
      color = per_change
    )
  ) +
  geom_sf(data = shp05,aes(), color = "red", fill ="NA") +
  geom_sf(data = shp1, color = "grey", fill ="NA") +
  geom_sf(data = shp2, color = "black", fill ="NA") +
  geom_sf(data = world_land,aes()) +
  coord_sf(xlim = c(-180,-110),
           ylim = c(-35,45)
  ) +
  labs(x = "",
       y = "") + 
  # scale_fill_viridis_c("") +
  # scale_color_viridis_c("") +
  scale_fill_gradient2("") +
  scale_color_gradient2("") +
  my_ggtheme_m(map_type = "reg", leg_pos = "right") +
  theme(axis.text.x = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank()) +
  # theme(
  #   panel.background = element_blank(), 
  #   strip.background = element_blank(), 
  #   panel.border = element_blank(), 
  #   panel.grid.minor = element_blank(),
  #   panel.grid.major = element_blank(),
  #   axis.line = element_line(color = "black"), 
  #   axis.ticks = element_blank(),
  #   axis.text.x = element_text(size = 10, face = "plain", color = "black"), 
  #   axis.text.y = element_text(size = 10, color = "black")
  # ) +
facet_grid(rcp~spp)

# ggsave("~/Data/ccz_tuna/results/figs/relative_change_all_esm/allgrids_spp.png",
#        last_plot(),
#        height = 8,
#        width = 10
#         
#     )

```


### Aggregated version

```{r aggregated_map, message = F}


st_as_sf(proportion_data,
         coords = c("lon","lat"),
         crs =4326
) %>%
  filter(zone == "CCZ") %>% 
  # Add all biomass within the CCZ
  group_by(year,time_step,zone,rcp,spp) %>% 
  summarise(total_biomass = sum(total_value)) %>% 
  # Average biomass within the CCZ at time period
  group_by(time_step,zone,rcp,spp) %>% 
  summarise(mean_time = mean(total_biomass)) %>% 
  # Estimate per_change
  spread(time_step,mean_time) %>% 
  mutate(per_change = round((future-present)/present*100)) %>%
  # Mab it!
  st_join(shp05,
          .,
          join = st_intersects) %>% 
  ggplot() +
  geom_sf(data = world_land,aes()) +
  geom_sf(aes(fill = per_change)) +
  coord_sf(xlim = c(-180,-110),
           ylim = c(-35,45)
  ) +
  scale_fill_viridis_c("") +
  my_ggtheme_m(map_type = "reg", leg_pos = "right") +
  theme(axis.text.x = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank()) +
  facet_grid(rcp~spp)


# ggsave("~/Data/ccz_tuna/results/figs/relative_change_all_esm/all_spp_agg.png",
#    last_plot(),
#    height = 8,
#    width = 10
#     
# )

```


## Time Series analysis

```{r}

# Set years for function
years <- seq(1980,2050,1)

suppressMessages( # remove annoying messages from function
  
  time_series_data <- bind_rows(
    lapply(years, data_analysis, sp = "skj"),
    lapply(years, data_analysis, sp = "yft"),
    lapply(years, data_analysis, sp = "bet")
  ) 
  
)

### Save extracted dataset
data_name_save <- paste0("~/Data/ccz_tuna/results/tables/time_series_all_esm.csv")

write_csv(x = time_series_data,
          file = data_name_save)


```


```{r}

time_series_data %>% 
  filter(zone == "CCZ") %>% 
  ggplot() +
  geom_line(
    aes(x = year,
        y = total_value,
        color = rcp)
  ) +
  labs(y = "Total biomas (10^6mt)",
       x = "Year") +
  facet_wrap(~spp, scales = "free") +
  scale_color_manual("RCP", values = c("black","green4","red")) +
  my_ggtheme_p()

# Save plot
ggsave("~/Data/ccz_tuna/results/figs/time_series/all_spp_esms.png",
       last_plot(),
       height = 5,
       width = 10
       
)

```


# For poWer point


```{r get_data}
source_file <- list.files("~/Data/ccz_tuna/results/tables/relative_change_all_esm/",full.names = T)
all_spp <- bind_rows(
  lapply(source_file, read.csv)
)

all_spp_sf <- st_as_sf(all_spp,
                       coords = c("lon","lat"),
                       crs =4326
)

```


```{r}


st_join(shp05,
        all_spp_sf,
        join = st_intersects) %>% 
  select(-zone) %>% 
  gather("time","value",h_value:f_value) %>% 
  group_by(CONTRACTOR,time,spp,rcp) %>% 
  summarise(total_area = sum(value,na.rm = T)) %>% 
  spread(time,total_area) %>% 
  mutate(per_change = round((f_value-h_value)/h_value*100)) %>%
  as.data.frame() %>% 
  select(spp,rcp,per_change) %>% 
  write_csv(.,"average_change.csv")



#     mutate(per_change = round((f_value-h_value)/h_value*100)) %>% 
#     ggplot() +
#     geom_sf(data = world_land,aes()) +
#     geom_sf(aes(fill = per_change)) +
#     coord_sf(xlim = c(-180,-110),
#          ylim = c(-35,45)
#          ) +
# # scale_fill_viridis_c("") +
# scale_fill_distiller(palette = "Blues") +
# # scale_fill_continuous() +
#     my_ggtheme_m(map_type = "reg", leg_pos = "right") +
# theme(axis.text.x = element_blank(),
#       strip.text.x = element_blank(),
#       strip.text.y = element_blank()) +
facet_grid(rcp~spp)



```


```{r}

all_spp %>% 
  filter(zone == "CCZ") %>% 
  mutate(per_change = ifelse(per_change>100,100,per_change)) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = per_change,
      color = per_change
    )
  ) +
  # geom_sf(data = shp05,aes(), color = "red", fill ="NA") +
  # geom_sf(data = shp1, color = "grey", fill ="NA") +
  geom_sf(data = shp2, color = "black", fill ="NA") +
  geom_sf(data = world_land,aes()) +
  coord_sf(xlim = c(-160,-115),
           ylim = c(0,35)
  ) +
  labs(x = "",
       y = "") + 
  scale_fill_viridis_c("") +
  scale_color_viridis_c("") +
  # scale_fill_gradient2("") +
  # scale_color_gradient2("") +
  my_ggtheme_m(map_type = "reg", leg_pos = "right") +
  theme(axis.text.x = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank()) +
  # theme(
  #   panel.background = element_blank(), 
  #   strip.background = element_blank(), 
  #   panel.border = element_blank(), 
  #   panel.grid.minor = element_blank(),
  #   panel.grid.major = element_blank(),
  #   axis.line = element_line(color = "black"), 
  #   axis.ticks = element_blank(),
  #   axis.text.x = element_text(size = 10, face = "plain", color = "black"), 
  #   axis.text.y = element_text(size = 10, color = "black")
  # ) +
facet_grid(rcp~spp)

ggsave("~/Data/ccz_tuna/results/figs/relative_change_all_esm/allgrids_spp_ppt.png",
       last_plot(),
       height = 8,
       width = 10
       
)
```

