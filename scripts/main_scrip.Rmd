---
title: "Untitled"
author: "Juliano Palacios"
date: "2023-02-10"
output: html_document
---

```{r setup, include=FALSE, message = F, warning = F}

library(MyFunctions)

packages <- c(
  # "readxl", # Read dataframe
  # "data.table", # Read dataframe (Fast!)
  # "wesanderson",
  "tidyverse", # for all data wrangling and ggplot
  "janitor", # for data cleaning
  # "tidytext", # to order the facet wrap https://juliasilge.com/blog/reorder-within/
  # "cowplot", # for figures 1 and 3
  # "ggimage", #for reading images to the circular plot
  # "ggrepel", # for nice plot labels
  # "ggsflabel", # for nice sf_plots labels
  # "spdep", # for poly2nb old
  "sf", #Spatial analysis 
  "sp", #Spatial analysis 
  # "purrr",#Spatial analysis
  # "rgdal", #Spatial analysis
  # "tools", #Spatial analysis 
  # "parallel", # for parallelization
  # "taxize", # For getting species names
  # "rfishbase", # for species ecosystem affinity
  # "zoo", #for runing mean
  # "pgirmess", # for dune test after kurtis wallas
  "rnaturalearth" # For maps
  # "R.matlab" # For Gabs distributions
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

# 
# file.source <- list.files("/Users/juliano/Data/ccz_tuna/doctools/lib/",full.names = T)
# 
# lapply(file.source,source)
# 


```

# Spatial exploration

From Jesse Van Der Grient at UH

I have added my shapefiles (see link below) based on 50, 100, and 200 km away from contract areas (indicated by the 0.5, 1 and 2 after the names) for the three different deposit types across the globe. I used these for the Watson database - the RFMO version has a clipped CCZ file, but I don't think we want to use that? Do let me know if you do want that. The projection is WGS 84, EPSG:4326. 

**Note:** We are using only the PMN shapefile

The acronyms are the theee different mineral resources, and each of those corresponds to areas where exploration licences have been granted in different oceans. For this project we will focus on PMN - polymetallic nodules of the Pacific Ocean.


## Map of CFC - cobalt ferromanganese crusts

```{r cmc_maps, eval = F, echo = F}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "cfc"

shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) # 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) # 200 kmm buffer

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

ggplot() +
  geom_sf(data = shp2, color = "blue") +
  geom_sf(data = shp1, color = "green") +
  geom_sf(data = shp05, color = "red") +
  geom_sf(data = world_land, aes()) +
  ggtitle(paste("Projections for",shp_name))

```

## PMN - polymetallic nodules

```{r pms_maps, eval = T, echo = T, message = FALSE}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "pmn"

# crop figure to CCZ
my_crop <- function(x){
  x <- st_crop(x,xmax = -100,
               xmin = -180,
               ymax = 35,
               ymin = -35)
  return(x)
}


shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) %>% # 200 kmm buffer
  my_crop(.) # 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) %>% # 200 kmm buffer
  my_crop(.) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) %>% # 200 kmm buffer
  my_crop(.) %>% 
  mutate(zone = "ccv")

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

ggplot() +
  geom_sf(data = shp2, color = "blue") +
  geom_sf(data = shp1, color = "green") +
  geom_sf(data = shp05, color = "red") +
  geom_sf(data = world_land, aes()) +
  ggtitle(paste("Projections for",shp_name))

```

### Create working grid

```{r}

```



## PMS - polymetallic sulphides

```{r pms_maps, eval = F, echo = F}

shp_path <- "/Users/juliano/Data/ccz_tuna/spatial/"
shp_name <- "pms"

shp05 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_0.5.shp")) # 50 kmm buffer
shp1 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_1.shp")) # 100 kmm buffer
shp2 <- st_read(paste0(shp_path,shp_name,"/",shp_name,"_2.shp")) # 200 kmm buffer

world_land <- ne_countries(scale = 'large', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)

ggplot() +
  geom_sf(data = shp2, color = "blue") +
  geom_sf(data = shp1, color = "green") +
  geom_sf(data = shp05, color = "red") +
  geom_sf(data = world_land, aes()) +
  ggtitle(paste("Projections for",shp_name))

```




# Tuna data exploration



```{r tuna_data_extraction, eval = T, echo = F}

# GLobal variables
region <- c(120.5,289.5,-45,45)
life.stage<-"adult";
rcps <- c(4.5,8.5)
# CM<-c("GFDL","IPSL","MIROC","MPI")
CM <- "GFDL"
SC <- c("REF","SO","SP","ST")
spp <- c("skj","yft","bet")


# Directories
# file.h<-paste(dir,"HISTORICAL/output/output_F0/",sp,"_",life.stage,".dym",sep="")
dir <- paste("~/Data/ccz_tuna/")

# dir.cc <- paste0("/Users/juliano/Data/ccz_tuna/outputs/",sp,"/RCP")
dir.out <- paste("~/Data/ccz_tuna/results/tables/")
file.cc<-list(rcp8.5=NULL,rcp4.5=NULL)

# From read-sea-var.R
# read.plot.mean.vars.contour()
data_extraction <- function(files,time_0,time_n,region, ccz = TRUE){
  
  t0 <- time_0
  tfin <- time_n
  
  #1. Read file.names data and average in time and over runs
  data <- read.var.dym(files[1],t0,tfin,region,dt = 30)
  vars<-data$var; tt<-data$t; x<-data$x; y<-data$y;
  nt <- length(tt) # months
  var <- sum1d(vars)/nt
  
  if (length(files)>1){
    for (n in 2:length(files)){
      data<-read.var.dym(files[n],t0,tfin,region,dt = 30)
      vars<-data$var; 
      vars<-ifelse(vars<=0,NA,vars)
      var<-var + sum1d(vars)/nt
    }
  }
  var<-var/length(files)
  # 
  var_df <- as.data.frame(var) %>% 
    bind_cols(x)
  colnames(var_df) <- c(y,"lon")
  
  df <- var_df %>%
    gather("lat","value",1:46) %>%
    mutate(lon = lon-360,
           lat = as.numeric(lat)) %>% 
    rowid_to_column()
  
  if(ccz == TRUE){
    
    ccz_index <- read_csv("~/Data/ccz_tuna/spatial/ccz_index.csv",show_col_types = FALSE)
    df <- df %>% 
      filter(rowid %in% ccz_index$rowid)
    return(df)
  }else{
    return(df)
  }
}
```


## Create Data grid

This sub step is to easier identify the CCZ zone, no need to run

```{r}
grid_data <- data_extraction(file.cc$rcp8.5[1],
                             time_0 = c(2000,1),
                             time_n = c(2011,12),
                             region = region) %>% 
  rowid_to_column()


grid_sf <- st_as_sf(grid_data,
                    coords = c("lon","lat"),
                    crs =4326
)

ccz_data <- st_join(shp2,
                    grid_sf,
                    join = st_intersects)

ccz_index <- as.data.frame(ccz_data) %>% 
  select(rowid)

write_csv(ccz_index,"ccz_index.csv")


```



## Rutine by pixel

```{r run_routine_pixel, eval = T, message = F}

for(s in 1:length(spp)){
  
  sp <- spp[s]
  
  dir.cc <- paste0("/Users/juliano/Data/ccz_tuna/outputs/",sp,"/RCP")
  # Create loading paths
  for (j in 1:length(CM))
    for (i in 1:length(SC)){
      file.cc$rcp4.5 <- c(file.cc$rcp4.5,paste(dir.cc,"4.5/",CM[j],"/",SC[i],"/output/output_F0/",
                                               sp,"_",life.stage,".dym",sep=""))
      file.cc$rcp8.5<-c(file.cc$rcp8.5,paste(dir.cc,"8.5/",CM[j],"/",SC[i],"/output/output_F0/",
                                             sp,"_",life.stage,".dym",sep=""))
    }
  
  for(r in 1:2){
    
    rcp = rcps[r]
    
    if(rcp == "8.5"){
      
      hist_data <- data_extraction(file.cc$rcp8.5,
                                   time_0 = c(2000,1),
                                   time_n = c(2020,12),
                                   region = region,
                                   ccz = T
                                   ) %>% 
        rename(h_value = value)
      
      future_data <- data_extraction(file.cc$rcp8.5,
                                     time_0 = c(2040,1),
                                     time_n = c(2060,12),
                                     region = region,
                                     ccz = T) %>% 
        rename(f_value = value)
      
      
    }else{
      hist_data <- data_extraction(file.cc$rcp4.5,
                                   time_0 = c(2000,1),
                                   time_n = c(2020,12),
                                   region = region,
                                   ccz = T) %>% 
        rename(h_value = value)
      
      future_data <- data_extraction(file.cc$rcp4.5,
                                     time_0 = c(2040,1),
                                     time_n = c(2060,12),
                                     region = region,
                                     ccz = T) %>% 
        rename(f_value = value)
    }
    
    # Estimate simple difference between time periods
    diff_data <- hist_data %>% 
      left_join(future_data) %>% 
      mutate(per_change = ((f_value-h_value)/h_value)*100,
             zone = "ccv")
    
    # Map by pixel version within the CCZ
    
    ggplot() +
      geom_tile(data = diff_data,
                aes(
                  x = lon,
                  y = as.numeric(lat),
                  fill = per_change
                )
      ) +
      geom_sf(data = shp2,aes(), color = "red", fill ="NA") +
      geom_sf(data = shp2, color = "orange", fill ="NA") +
      geom_sf(data = shp1, color = "green", fill ="NA") +
      geom_sf(data = world_land,aes()) +
      coord_sf(xlim = c(-180,-110),
               ylim = c(-35,45)
      ) +
      labs(x = "Long",
           y = "Lat") + 
      scale_fill_gradient2("Difference") +
      ggtitle(paste("Change of",sp ,"by 2050 relative to present under rcp",rcp))
    
    name_save <- paste0("~/Data/ccz_tuna/results/figs/",sp,"_rcp",rcp,"_pixel_chg_2050.png")
    
    ggsave(name_save,
           last_plot()
    )
    
    # AGGREGATED VERSION ON THE CCZ
    
    diff_data_sf <- st_as_sf(diff_data,
                             coords = c("lon","lat"),
                             crs =4326
    )
    
    st_join(shp2,diff_data_sf,
            join = st_intersects) %>% 
      gather("time","value",h_value:f_value) %>% 
      group_by(CONTRACTOR,time) %>% 
      summarise(total_area = sum(value,na.rm = T)) %>% 
      spread(time,total_area) %>% 
      mutate(per_change = round((f_value-h_value)/h_value*100)) %>% 
      ggplot() +
      geom_sf(aes(fill = per_change)) +
      ggtitle(paste("CCZ change of",sp ,"by 2050 relative to present under rcp",rcp))
    
    
    name_save <- paste0("~/Data/ccz_tuna/results/figs/",sp,"_rcp",rcp,"_ccz_chg_2050.png")
    
    ggsave(name_save,
           last_plot()
    )
    
  }
  
}

```




# Obsolete code

## Rectangular extraction 

This routine is working but outputs values for the whole rectangle with no coordinates

```{r tuna_data_exploration}

source("functions.R")

# sps<-c("skj","yft","bet")
sps <- "YFT"

reg.WCPO<-c(120,210,-40,45)
reg.EPO<-c(210,290,-40,45)	  
regions<-matrix(c(reg.WCPO,reg.EPO),ncol=2)
reg.names<-c("WCPO","EPO")

for (sp in sps){
  
  
  life.stage<-"adult"; 
  
  # rcp<-c(8.5,4.5)
  rcp <- "4.5"
  # CM<-c("GFDL","IPSL","MIROC","MPI")
  CM <- "GFDL"
  SC<-c("REF","SO","SP","ST")
  
  # dir<-paste("/data/SEAPODYM/PROJECTS/SPC/SPC-2018/sim/",toupper(sp),"/",sep="")
  
  # JEPA 
  dir <- paste("~/Data/ccz_tuna/")
  file.h<-paste(dir,"HISTORICAL/output/output_F0/",sp,"_",life.stage,".dym",sep="")
  dir.cc <- paste0("/Users/juliano/Data/ccz_tuna/outputs/",sp,"/RCP")
  dir.out <- paste("~/Data/ccz_tuna/results/tables/")
  file.cc<-list(rcp8.5=NULL,rcp4.5=NULL)
  
  
  for (j in 1:length(CM))
    for (i in 1:length(SC)){
      file.cc$rcp4.5 <- c(file.cc$rcp4.5,paste(dir.cc,"4.5/",CM[j],"/",SC[i],"/output/output_F0/",
                                               sp,"_",life.stage,".dym",sep=""))
      file.cc$rcp8.5<-c(file.cc$rcp8.5,paste(dir.cc,"8.5/",CM[j],"/",SC[i],"/output/output_F0/",
                                             sp,"_",life.stage,".dym",sep=""))
    }
  
  # Extract data
  #     for (n in 1:length(CM)){
  #   write.ts.reg(file.cc$rcp4.5[n],t0=c(2011,1),tfin=c(2055,12),regions,paste("rcp45_",CM[n],sep=""))
  #   write.ts.reg(file.cc$rcp8.5[n],t0=c(2011,1),tfin=c(2055,12),regions,paste("rcp85_",CM[n],sep=""))
  #   } 
} # Close species loop


```